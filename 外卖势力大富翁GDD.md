# 外卖势力大富翁（H5）— GDD（策划迭代版）

版本：v0.2（合并奇遇与社交系统，确立 AI 优先）  
维护方式：每次玩法/数值/内容改动，在本文件对应章节补充“变更记录”与“待验证项”。

---

## 1. 游戏概述

### 1.1 一句话描述
手机竖屏的回合制地图棋盘小游戏：通过移动、经营店铺券、命运事件与势力技能，在有限资源（电量/资金）约束下率先集齐目标店铺券数量获胜。

### 1.2 目标平台与形态
- 平台：移动端浏览器（H5），可部署 Cloudflare Pages
- 方向：轻量、快节奏、单局可复玩、策略与随机并存
- 屏幕：竖屏优先（沉浸式全屏）

### 1.3 核心卖点（Pillars）
- 走格子 + 选路：地图连线提供路径选择与风险控制
- 资源约束：电量决定行动能力，资金决定经营能力
- 强对抗：技能干扰（暂停/转化）+ 命运事件制造波动 + **社交偷取/破坏（异步）**
- 轻收集：店铺券（按名称去重）作为胜利进度

---

## 2. 目标用户与体验指标

### 2.1 目标用户
- 喜欢大富翁/棋盘类、轻策略对抗与随机事件的玩家
- 偏休闲：单局 5–12 分钟，易上手

### 2.2 体验指标（建议）
- 上手时间：30 秒内完成开局设置并开始掷骰
- 关键爽点：获得关键店铺券、触发连锁命运、技能反杀、**破坏对手站点**
- 可复玩：同一玩家连续玩 3 局仍能看到新组合/新事件

---

## 3. 单局流程与胜负规则

### 3.1 开局设置（Setup）
1. 选择胜利目标（店铺券数量）：5–10（可扩展）
2. 选择玩家数：2–4（支持**人机对战**）
3. 逐个选择势力（不可重复）

### 3.2 胜利条件
- 任意玩家拥有的“不同店铺券名称”数量 ≥ `victoryTarget` 时立刻获胜
- 判定时机：购买店铺后立即判定

### 3.3 回合定义
- “轮（Round）”：所有玩家各行动一次算一轮
- “回合（Turn）”：当前行动玩家的一次完整行动
- 全局 `turn` 在轮结束时 +1

---

## 4. 核心系统（当前实现对齐）

### 4.1 地图系统
#### 4.1.1 规模与类型分布
- 节点总数：40
- 类型数量：店铺(10)、命运(8)、充电桩(4)、打工点(4)、医院(2)、普通(12)

#### 4.1.2 布局与连接
- 双环布局：外环 24 + 内环 16
- 主连接：i -> i+1（构成闭环）
- 捷径：概率性添加 3–8 步的近距离连接

### 4.2 移动系统
- 掷骰：1–3 点
- 移动：消耗电量（默认 0.5/步）
- 路径：玩家手动选择相邻节点

### 4.3 资源系统
- **电量（Power）**：移动成本、技能成本。来源：充电桩、事件。
- **资金（Money）**：买店、技能、罚金。来源：打工、事件、返利。

### 4.4 紧急充电（Fail-safe）
- 触发：掷骰前电量不足移动一步
- 效果：随机传送至充电桩，扣 2 元，补满电量，结束回合。

---

## 5. 节点（格子）规则

### 5.1 店铺（shop）
- 到达空铺：可购买（扣钱，得券）。
- 价格：基础价 + 势力加价 - Buff折扣。
- 到达己方店铺：+1 元（可扩展）。
- 到达敌方店铺：暂无惩罚（可迭代为交过路费）。

### 5.2 功能节点
- **充电桩**：增加电量（按势力加成）。
- **打工点**：增加资金（按势力加成）。
- **医院**：下回合暂停（叮咚免疫）。

### 5.3 命运（fate）
进入后抽取一条命运事件。详见第 8 章。

---

## 6. Buff / 状态 / 冷却
- **Buff**：一次性（如下次买店-2）或持续性（如禁充5回合）。
- **冷却**：主动技能冷却、被动触发冷却（如饿了么高电量返利）。

---

## 7. 势力（Factions）设计
- **叮咚买菜**：稳定运营，医院免疫，周期回复。
- **国潮外卖**：干扰控场，主动暂停对手，移动耗电高。
- **美团外卖**：连锁经营，甜品/饮品返利。
- **饿了么**：电量爆发，充电收益高，电换钱。

---

## 8. 命运事件系统（升级版）

### 8.1 奇遇事件分类
引入 **[增益/损益/策略]** 三类，并引入数值权重。

| 事件名称 | 类型 | 效果示例 | 策划描述 |
| :--- | :--- | :--- | :--- |
| **豪爽小费** | 增益 | 现金 +15% ~ 30% | 遇到大方老板，心情大好。 |
| **超时罚单** | 损益 | 现金 -10% | 平台扣除违规款项。 |
| **雨天竞速** | 策略 | 步数 +2（持续2轮） | 速度强制提升，但可能错过格子。 |
| **爆胎危机** | 损益 | 停跳 1 轮 | 电瓶车坏了，原地修理。 |
| **锦鲤订单** | 增益 | 获得 1 个“护盾” | 抵御一次社交破坏。 |
| **黄金时段** | 增益 | 下 3 次落点收入 x2 | 午高峰来临，单单大单。 |

### 8.2 数据结构建议
```json
{
  "id": "lucky_tip",
  "name": "豪爽小费",
  "type": "gain_money",
  "weight": 30,
  "effect": { "money_percent": [15, 30] }
}
```

---

## 9. UI/UX 迭代建议

### 9.1 界面升级
- **顶栏状态区**：新增**护盾图标**（1-3个，发光激活）、**Buff 状态角标**。
- **事件弹出层**：设计类似“刮刮乐”或“订单单据”的动效，增加仪式感。
- **社交破坏动效**：攻击时切换至简易地图，配合震动与特效。
- **排行榜**：增加“最惨外卖员”和“最强站点”维度。

---

## 10. AI（人机对战）— 实施计划

### 10.1 核心目标
实现单人可玩，AI 能模拟玩家行为，具备基础策略。

### 10.2 AI 决策逻辑
1.  **移动决策**：
    *   计算所有可行路径（深度优先搜索，步数=骰子点数）。
    *   评分系统：
        *   目标节点是“未拥有店铺”且买得起：+10 分。
        *   目标节点是“充电桩”且电量低：+20 分。
        *   目标节点是“命运”：根据当前优势/劣势动态评分（落后时更倾向冒险）。
2.  **购买决策**：
    *   若 `money >= price + 保留金`（保留金防紧急充电），则购买。
    *   若该店铺能直接达成胜利条件，不顾一切购买。
3.  **技能使用**：
    *   干扰技能：优先对领先玩家（券最多）使用。
    *   资源技能：冷却好且资源满足条件即用。

---

## 11. 联机与社交（异步交互）

### 11.1 异步联机：偷取与破坏 (Social Sabotage)
参考 *Monopoly GO!*，增加强互动。

#### 11.1.1 破坏 (Shutdown)
- **触发**：停留在“社交格子”（或特定命运）。
- **流程**：系统匹配一名“附近的外卖员”（其他玩家/AI）。
- **判定**：
    - 对方有**护盾**：攻击被挡，获得少量安慰金，对方护盾 -1。
    - 对方无护盾：攻击成功，对方店铺降级/受损，获得大量金币。

#### 11.1.2 偷取 (Heist)
- **流程**：3x3 翻牌小游戏。
- **玩法**：翻开箱子直到凑齐 3 个相同图标（小费/外卖箱/金条）。
- **后果**：按比例窃取对方资金。

### 11.2 技术实现方案（轻量级）
- **初期**：无需 WebSocket。
- **同步**：玩家操作结束同步状态到后端（Cloudflare KV / Firebase）。
- **交互**：攻击时拉取快照，结算后上传日志。

---

## 12. 数值表（参考）
（沿用现有数据，详见 `src/data` 目录）

---

## 13. 版本规划与 Roadmap

### 13.1 v0.3：内容扩充与视觉升级 (已完成)
- [x] 实装“奇遇事件系统升级”（权重、分类、新UI）。
- [x] 实装“护盾”系统与 UI。
- [x] 增加更多店铺与地图元素。

### 13.2 v0.4：异步社交与联机 (已完成)
- [x] 实现“破坏”与“偷取”逻辑（已对战 AI 实现）。
- [x] 新增“社交格子” (Social Node) 地图类型。
- [ ] 后端接入：存档同步与排行榜（CF KV 模拟）。
- [ ] 真实玩家异步对战。

### 13.3 v0.5：数值平衡与多端优化 (下个目标)
- [ ] 动态难度调整（根据玩家资金调整事件概率）。
- [ ] 更多社交互动：送礼、组队订单。
- [ ] 响应式布局深度优化。

---

## 14. 技术实现参考（新增）

### 14.1 模块化架构
1.  **Event Manager**：配置读取、权重计算、后果下发。
2.  **AI Service**：无状态函数，输入 `GameState`，输出 `Action`。
3.  **Social Service**：处理攻击请求与快照读取。

### 14.2 代码示例（事件权重）
```javascript
const eventPool = [
    { name: "豪爽小费", type: "gain_money", weight: 30 },
    { name: "超时罚单", type: "lose_money", weight: 20 },
    // ...
];

function triggerEvent(player) {
    // 基于权重的随机算法
    const totalWeight = eventPool.reduce((sum, e) => sum + e.weight, 0);
    let random = Math.random() * totalWeight;
    for (const event of eventPool) {
        if (random < event.weight) return event;
        random -= event.weight;
    }
}
```

---

## 15. 变更记录
- 2026-01-09 v0.1: 初始 GDD，确立核心玩法。
- 2026-01-09 v0.2: 合并奇遇与社交系统，确立 AI 对战为首要开发目标。
- 2026-01-09 v0.3: 完成命运系统升级、护盾系统及订单风格 UI。
- 2026-01-09 v0.4: 开始社交破坏（Shutdown/Heist）系统迭代。
